<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèí Swiss Cup Crawler - Datenbank Review</title>
    <link rel="stylesheet" href="dbreview.css">
</head>
<body>
    <div class="container">
        <h1>üèí Swiss Cup Crawler - Datenbank Review</h1>
        
        <div class="controls">
            <div class="stats-info" id="statsInfo">üìä Klicke "Alle laden" um zu starten</div>
            <div class="control-actions">
                <button class="btn btn-primary" onclick="loadAllGames()">üîÑ Alle laden</button>
                <button class="btn btn-secondary" onclick="exportCSV()">üì• CSV Export</button>
                <a href="/" class="btn btn-secondary">üè† Zur√ºck</a>
            </div>
        </div>

        <div id="alertContainer"></div>

        <div class="table-container">
            <div class="table-wrapper">
                <table id="gamesTable">
                    <thead id="tableHead">
                        <tr id="filterRow">
                            <th><input oninput="filterTable()" placeholder="gameid"></th>
                            <th><input oninput="filterTable()" placeholder="team1"></th>
                            <th><input oninput="filterTable()" placeholder="team2"></th>
                            <th><input oninput="filterTable()" placeholder="roundname"></th>
                            <th><input oninput="filterTable()" placeholder="roundid"></th>
                            <th><input oninput="filterTable()" placeholder="tournamentid"></th>
                            <th><input oninput="filterTable()" placeholder="tournamentname"></th>
                            <th><input oninput="filterTable()" placeholder="season"></th>
                            <th><input oninput="filterTable()" placeholder="cuptype"></th>
                            <th><input oninput="filterTable()" placeholder="gender"></th>
                            <th><input oninput="filterTable()" placeholder="fieldtype"></th>
                            <th><input oninput="filterTable()" placeholder="gamedate"></th>
                            <th><input oninput="filterTable()" placeholder="gametime"></th>
                            <th><input oninput="filterTable()" placeholder="venue"></th>
                            <th><input oninput="filterTable()" placeholder="status"></th>
                            <th><input oninput="filterTable()" placeholder="result"></th>
                            <th><input oninput="filterTable()" placeholder="source"></th>
                            <th><input oninput="filterTable()" placeholder="apiendpoint"></th>
                            <th><input oninput="filterTable()" placeholder="link"></th>
                            <th><input oninput="filterTable()" placeholder="hometeamscore"></th>
                            <th><input oninput="filterTable()" placeholder="awayteamscore"></th>
                            <th><input oninput="filterTable()" placeholder="gamelocation"></th>
                            <th><input oninput="filterTable()" placeholder="referees"></th>
                            <th><input oninput="filterTable()" placeholder="spectators"></th>
                            <th><input oninput="filterTable()" placeholder="notes"></th>
                            <th><input oninput="filterTable()" placeholder="numericgameid"></th>
                            <th><input oninput="filterTable()" placeholder="bracketsortorder"></th>
                            <th><input oninput="filterTable()" placeholder="crawledat"></th>
                            <th><input oninput="filterTable()" placeholder="updatedat"></th>
                        </tr>
                        <tr>
                            <th onclick="sortTable('gameid')">gameid <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('team1')">team1 <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('team2')">team2 <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('roundname')">roundname <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('roundid')">roundid <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('tournamentid')">tournamentid <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('tournamentname')">tournamentname <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('season')">season <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('cuptype')">cuptype <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('gender')">gender <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('fieldtype')">fieldtype <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('gamedate')">gamedate <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('gametime')">gametime <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('venue')">venue <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('status')">status <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('result')">result <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('source')">source <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('apiendpoint')">apiendpoint <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('link')">link <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('hometeamscore')">hometeamscore <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('awayteamscore')">awayteamscore <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('gamelocation')">gamelocation <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('referees')">referees <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('spectators')">spectators <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('notes')">notes <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('numericgameid')">numericgameid <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('bracketsortorder')">bracketsortorder <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('crawledat')">crawledat <span class="sort-icon">‚Üï</span></th>
                            <th onclick="sortTable('updatedat')">updatedat <span class="sort-icon">‚Üï</span></th>
                        </tr>
                    </thead>
                    <tbody id="gamesTableBody">
                        <tr>
                            <td colspan="29" class="loading">Klicke "Alle laden" um die Spiele zu laden</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let allGames = [];
        let filteredGames = [];
        let currentSort = { column: 'crawledat', direction: 'desc' };

        async function loadAllGames() {
            try {
                showLoading();
                showAlert('üîÑ Lade Spiele...', 'info');
                
                const response = await fetch('/games/all');
                if (!response.ok) throw new Error(`Server Error: ${response.status} ${response.statusText}`);
                
                allGames = await response.json();
                filteredGames = allGames;
                displayGames(filteredGames);
                updateStats();
                showAlert(`‚úÖ ${allGames.length} Spiele erfolgreich geladen`, 'success');
                
            } catch (error) {
                console.error('Error loading games:', error);
                showAlert(`‚ùå Fehler: ${error.message}`, 'error');
                showNoData();
            }
        }

        function displayGames(games) {
            const tbody = document.getElementById('gamesTableBody');
            if (!games || games.length === 0) { showNoData(); return; }
            
            tbody.innerHTML = '';
            const displayGames = games.slice(0, 500);
            
            displayGames.forEach(game => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td title="${game.gameid || ''}">${truncate(game.gameid || '', 15)}</td>
                    <td>${game.team1 || ''}</td>
                    <td>${game.team2 || ''}</td>
                    <td>${game.roundname || ''}</td>
                    <td>${game.roundid || ''}</td>
                    <td>${game.tournamentid || ''}</td>
                    <td>${game.tournamentname || ''}</td>
                    <td>${game.season || ''}</td>
                    <td><span class="cup-badge cup-${game.cuptype}">${formatCupType(game.cuptype)}</span></td>
                    <td>${game.gender || ''}</td>
                    <td>${game.fieldtype || ''}</td>
                    <td>${game.gamedate || ''}</td>
                    <td>${game.gametime || ''}</td>
                    <td>${game.venue || ''}</td>
                    <td><span class="status-badge status-${game.status}">${formatStatus(game.status)}</span></td>
                    <td class="result">${game.result || 'TBD'}</td>
                    <td>${game.source || ''}</td>
                    <td>${game.apiendpoint || ''}</td>
                    <td>${game.link ? `<a href="${game.link}" target="_blank" class="external-link">üîó</a>` : '-'}</td>
                    <td>${game.hometeamscore ?? ''}</td>
                    <td>${game.awayteamscore ?? ''}</td>
                    <td>${game.gamelocation || ''}</td>
                    <td>${game.referees || ''}</td>
                    <td>${game.spectators ?? ''}</td>
                    <td>${game.notes || ''}</td>
                    <td>${game.numericgameid || ''}</td>
                    <td>${game.bracketsortorder || ''}</td>
                    <td>${game.crawledat || ''}</td>
                    <td>${game.updatedat || ''}</td>
                `;
                tbody.appendChild(row);
            });
            
            if (games.length > 500) {
                const infoRow = document.createElement('tr');
                infoRow.innerHTML = `<td colspan="29" class="info-message">Zeige ersten 500 von ${games.length} Spielen (Performance-Optimierung)</td>`;
                tbody.appendChild(infoRow);
            }
        }

        function sortTable(column, silent = false) {
            // Sortier‚ÄêLogik nur √§ndern, wenn der Aufruf NICHT ‚Äûsilent" ist
            if (!silent) {
                if (currentSort.column === column) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = column;
                    currentSort.direction = 'asc';
                }
            }

            const numericCols = ['numericgameid', 'hometeamscore', 'awayteamscore', 'bracketsortorder', 'spectators'];
            const sortedGames = [...filteredGames].sort((a, b) => {
                let valA = a[column] ?? '';
                let valB = b[column] ?? '';

                if (numericCols.includes(column)) {
                    valA = parseInt(valA) || 0;
                    valB = parseInt(valB) || 0;
                } else if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }

                if (currentSort.direction === 'asc') return valA < valB ? -1 : valA > valB ? 1 : 0;
                return valA > valB ? -1 : valA < valB ? 1 : 0;
            });

            filteredGames = sortedGames;
            displayGames(filteredGames);

            // Header nur neu setzen, wenn NICHT ‚Äûsilent"
            if (!silent) updateSortHeaders();
        }

        function updateSortHeaders() {
            document.querySelectorAll('th .sort-icon').forEach(icon => {
                icon.textContent = '‚Üï';
                icon.parentElement.classList.remove('sort-asc', 'sort-desc');
            });
            const currentHeader = document.querySelector(`th[onclick*="${currentSort.column}"]`);
            if (currentHeader) {
                const icon = currentHeader.querySelector('.sort-icon');
                icon.textContent = currentSort.direction === 'asc' ? '‚Üë' : '‚Üì';
                currentHeader.classList.add(`sort-${currentSort.direction}`);
            }
        }

        function formatStatus(status) {
            const map = { scheduled: 'Geplant', finished: 'Beendet', cancelled: 'Abgesagt', prognose: 'Prognose' };
            return map[status] || status || 'Unbekannt';
        }

        function formatCupType(cupType) {
            const map = { herren_grossfeld: 'H-GF', damen_grossfeld: 'D-GF', herren_kleinfeld: 'H-KF', damen_kleinfeld: 'D-KF' };
            return map[cupType] || cupType || 'Unbekannt';
        }

        const truncate = (str, len) => (!str ? '' : str.length > len ? str.slice(0, len) + '‚Ä¶' : str);

        function updateStats() {
            const total = allGames.length;
            const seasons = new Set(allGames.map(g => g.season).filter(Boolean)).size;
            const cupTypes = new Set(allGames.map(g => g.cuptype).filter(Boolean)).size;
            const tournaments = new Set(allGames.map(g => g.tournamentid).filter(Boolean)).size;
            document.getElementById('statsInfo').innerHTML = `üìä ${total} Spiele | ${seasons} Saisons | ${cupTypes} Cup-Typen | ${tournaments} Turniere`;
        }

        const showLoading = () => document.getElementById('gamesTableBody').innerHTML = `<tr><td colspan="29" class="loading">üìä Lade alle Spiele‚Ä¶</td></tr>`;
        const showNoData  = () => document.getElementById('gamesTableBody').innerHTML = `<tr><td colspan="29" class="no-data">ü§∑‚Äç‚ôÇÔ∏è Keine Spiele gefunden</td></tr>`;

        function showAlert(msg, type='info') {
            const c = document.getElementById('alertContainer');
            c.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
            if (['success','info'].includes(type)) setTimeout(() => c.innerHTML = '', 3000);
        }

        function exportCSV() {
            if (!allGames.length) { showAlert('‚ùå Keine Daten zum Exportieren vorhanden','error'); return; }
            const headers = ['gameid','team1','team2','roundname','roundid','tournamentid','tournamentname','season','cuptype','gender','fieldtype','gamedate','gametime','venue','status','result','source','apiendpoint','link','hometeamscore','awayteamscore','gamelocation','referees','spectators','notes','numericgameid','bracketsortorder','crawledat','updatedat'];
            const csv = [headers.join(','), ...allGames.map(g => headers.map(h => `"${(g[h] ?? '').toString().replace(/"/g,'""')}"`).join(','))].join('\n');
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const url  = URL.createObjectURL(blob);
            const a    = Object.assign(document.createElement('a'), {href:url, download:`swiss_cup_games_${new Date().toISOString().split('T')[0]}.csv`});
            document.body.appendChild(a); a.click(); a.remove();
            showAlert(`‚úÖ CSV-Export erfolgreich: ${allGames.length} Spiele`,'success');
        }

        function filterTable() {
            const inputs = Array.from(document.querySelectorAll('#filterRow input'));
            const filters = inputs.map(input => input.value.trim().toLowerCase());

            const filtered = allGames.filter(game => {
                const values = [
                    game.gameid, game.team1, game.team2, game.roundname, game.roundid,
                    game.tournamentid, game.tournamentname, game.season, game.cuptype,
                    game.gender, game.fieldtype, game.gamedate, game.gametime, game.venue,
                    game.status, game.result, game.source, game.apiendpoint, game.link,
                    game.hometeamscore, game.awayteamscore, game.gamelocation, game.referees,
                    game.spectators, game.notes, game.numericgameid, game.bracketsortorder,
                    game.crawledat, game.updatedat
                ];

                return values.every((value, index) => {
                    const text = (value ?? '').toString().toLowerCase();
                    return text.includes(filters[index]);
                });
            });
            filteredGames = filtered;
            displayGames(filtered);
            sortTable(currentSort.column, true); // true = interner Aufruf
        }
    </script>
</body>
</html>